<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>せせらぎ企画室｜雛人形とインテリアの色彩調和システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <style>
        :root {
            --base-color: #F5F5DC; /* ベージュ */
            --main-color: #669999; /* 青緑系 */
            --accent-color: #D2B48C; /* 淡いゴールド */
            --text-color: #333333; /* チャコールグレー */
            --light-gray: #f0f0f0;
            --white: #ffffff;
        }
        body {
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            background-color: var(--base-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
      .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--main-color);
            padding-bottom: 20px;
        }
        header h1 {
            color: var(--main-color);
            margin: 0;
        }
        header p {
            margin: 5px 0 0;
            font-size: 0.9em;
        }
      .analysis-section {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
      .image-analyzer {
            flex: 1;
            border: 2px dashed var(--light-gray);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
      .image-analyzer h2 {
            margin-top: 0;
            color: var(--main-color);
        }
      .preview-container {
            width: 100%;
            height: 200px;
            background-color: var(--light-gray);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            overflow: hidden;
        }
      .preview-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
      .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
      .btn {
            border: 2px solid var(--main-color);
            color: var(--main-color);
            background-color: var(--white);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
      .btn:hover {
            background-color: var(--main-color);
            color: var(--white);
        }
      .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
      .palette-container {
            margin-top: 20px;
        }
      .palette-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
      .palette {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
      .color-chip {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
      .result-section {
            background-color: #f9f9f9;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
      .result-section h2 {
            color: var(--main-color);
            margin-top: 0;
        }
        #harmony-suggestion {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
      .harmony-colors {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }
      .harmony-color-item {
            text-align: center;
        }
      .harmony-color-item.color-chip { /* classセレクタの修正 */
            margin: 0 auto 5px;
        }
      .harmony-color-item.label { /* classセレクタの修正 */
            font-size: 0.8em;
            font-weight: bold;
        }
      .harmony-advice {
            text-align: left;
            font-size: 0.95em;
            background-color: var(--white);
            padding: 15px;
            border-radius: 4px;
            border-left: 5px solid var(--accent-color);
        }
        @media (max-width: 768px) {
          .analysis-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>せせらぎ企画室</h1>
            <p>雛人形とインテリアの色彩調和システム</p>
        </header>

        <div class="analysis-section">
            <div class="image-analyzer">
                <h2>1. お雛様の写真をアップロード</h2>
                <div class="preview-container" id="doll-preview-container">
                    <img id="doll-preview" class="preview-image" alt="雛人形のプレビュー">
                </div>
                <div class="upload-btn-wrapper">
                    <button class="btn">写真を選択</button>
                    <input type="file" id="doll-upload" accept="image/*">
                </div>
                <div class="palette-container" id="doll-palette-container">
                    <p class="palette-title">カラーパレット</p>
                    <div class="palette" id="doll-palette"></div>
                </div>
            </div>

            <div class="image-analyzer">
                <h2>2. お部屋の写真をアップロード</h2>
                <div class="preview-container" id="interior-preview-container">
                    <img id="interior-preview" class="preview-image" alt="お部屋のプレビュー">
                </div>
                <div class="upload-btn-wrapper">
                    <button class="btn">写真を選択</button>
                    <input type="file" id="interior-upload" accept="image/*">
                </div>
                <div class="palette-container" id="interior-palette-container">
                    <p class="palette-title">カラーパレット</p>
                    <div class="palette" id="interior-palette"></div>
                </div>
            </div>
        </div>

        <div class="result-section">
            <h2>3. 色彩調和のご提案</h2>
            <div id="harmony-suggestion">
                <p>お雛様とお部屋の写真を両方アップロードすると、ここに調和案が表示されます。</p>
            </div>
        </div>
    </div>

    <script>
        // Color Thiefのインスタンスを作成
        const colorThief = new ColorThief();

        // DOM要素を取得
        const dollUpload = document.getElementById('doll-upload');
        const interiorUpload = document.getElementById('interior-upload');
        const dollPreview = document.getElementById('doll-preview');
        const interiorPreview = document.getElementById('interior-preview');
        const dollPaletteContainer = document.getElementById('doll-palette');
        const interiorPaletteContainer = document.getElementById('interior-palette');
        const harmonySuggestion = document.getElementById('harmony-suggestion');

        // 解析結果を保持するオブジェクト
        let analysisResults = {
            doll: null,
            interior: null
        };

        // ファイルアップロード時のイベントリスナーを設定
        dollUpload.addEventListener('change', (e) => handleImageUpload(e, 'doll', dollPreview, dollPaletteContainer));
        interiorUpload.addEventListener('change', (e) => handleImageUpload(e, 'interior', interiorPreview, interiorPaletteContainer));

        /**
         * 画像がアップロードされた際のメイン処理
         * @param {Event} event - ファイル選択イベント
         * @param {string} type - 'doll' または 'interior'
         * @param {HTMLImageElement} previewEl - プレビュー表示用のimg要素
         * @param {HTMLElement} paletteEl - パレット表示用のdiv要素
         */
        async function handleImageUpload(event, type, previewEl, paletteEl) {
            const file = event.target.files[0]; // ★ 修正：FileListから最初のファイルを取得
            if (!file) return;

            // 画像をプレビュー表示
            const reader = new FileReader();
            reader.onload = (e) => {
                previewEl.src = e.target.result;
                // 画像の読み込み完了を待ってから解析処理へ
                previewEl.onload = async () => {
                    try {
                        // カラーパレットを抽出
                        const palette = await colorThief.getPalette(previewEl, 5);
                        analysisResults[type] = palette;
                        
                        // 画面にパレットを表示
                        displayPalette(palette, paletteEl);
                        
                        // 両方の画像が解析済みなら、調和案を生成
                        if (analysisResults.doll && analysisResults.interior) {
                            generateHarmonySuggestion();
                        }
                    } catch (error) {
                        console.error('Error analyzing image:', error);
                        alert('画像の解析中にエラーが発生しました。別の画像でお試しください。');
                    }
                };
            };
            reader.readAsDataURL(file); // ★ 修正：単一のファイルを読み込む
        }

        /**
         * 抽出したカラーパレットを画面に表示する
         * @param {Array<Array<number>>} palette - RGB値の配列の配列
         * @param {HTMLElement} container - 表示先のコンテナ要素
         */
        function displayPalette(palette, container) {
            container.innerHTML = ''; // 既存のパレットをクリア
            palette.forEach(color => {
                const colorChip = document.createElement('div');
                colorChip.className = 'color-chip';
                // ★ 修正：color配列の各要素を渡す
                colorChip.style.backgroundColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                colorChip.title = `RGB: ${color.join(', ')}`;
                container.appendChild(colorChip);
            });
        }

        /**
         * 2つのパレットから調和案を生成して表示する
         */
        function generateHarmonySuggestion() {
            if (!analysisResults.doll || !analysisResults.interior) return;

            // ★ 修正：パレットから特定の色を取得
            const baseColor = analysisResults.interior[0];
            const mainColor = analysisResults.interior[1];

            // 雛人形から最も鮮やかな色（アクセントカラー）を特定
            const accentColor = findMostSaturatedColor(analysisResults.doll);

            // ★ 修正：RGB配列の要素を引数として渡す
            const baseHex = rgbToHex(baseColor[0], baseColor[1], baseColor[2]);
            const mainHex = rgbToHex(mainColor[0], mainColor[1], mainColor[2]);
            const accentHex = rgbToHex(accentColor[0], accentColor[1], accentColor[2]);

            // HTMLを生成して表示
            harmonySuggestion.innerHTML = `
                <div style="width: 100%;">
                    <div class="harmony-colors">
                        <div class="harmony-color-item">
                            <div class="color-chip" style="background-color: ${baseHex};"></div>
                            <div class="label">ベースカラー (70%)</div>
                            <div>${baseHex}</div>
                        </div>
                        <div class="harmony-color-item">
                            <div class="color-chip" style="background-color: ${mainHex};"></div>
                            <div class="label">アソートカラー (25%)</div>
                            <div>${mainHex}</div>
                        </div>
                        <div class="harmony-color-item">
                            <div class="color-chip" style="background-color: ${accentHex};"></div>
                            <div class="label">アクセントカラー (5%)</div>
                            <div>${accentHex}</div>
                        </div>
                    </div>
                    <div class="harmony-advice">
                        <p><strong>【ご提案】</strong></p>
                        <p>
                            お部屋の基本色である<strong>${baseHex}</strong>（壁や床など）と、主役となる家具の色<strong>${mainHex}</strong>（ソファやカーテンなど）を基調としながら、
                            お雛様から抽出した、この鮮やかな<strong>${accentHex}</strong>をクッションや花瓶、テーブルランナーといった小物で取り入れてみてください。
                            お雛様の持つ美しい色彩がお部屋全体に自然に溶け込み、統一感のある洗練された空間を演出できます。
                        </p>
                    </div>
                </div>
            `;
        }

        /**
         * パレットの中から最も彩度の高い色を見つける
         * @param {Array<Array<number>>} palette - RGB値の配列の配列
         * @returns {Array<number>} 最も彩度の高い色のRGB値
         */
        function findMostSaturatedColor(palette) {
            // ★ 修正：初期値をパレットの最初の色に設定
            let mostSaturated = { color: palette[0], saturation: 0 };
            palette.forEach(rgb => {
                // ★ 修正：RGB配列の要素を引数として渡す
                const hsl = rgbToHsl(rgb[0], rgb[1], rgb[2]);
                const saturation = hsl[1];
                if (saturation > mostSaturated.saturation) {
                    mostSaturated = { color: rgb, saturation: saturation };
                }
            });
            return mostSaturated.color;
        }

        // --- ユーティリティ関数 ---

        /**
         * RGBをHEXコードに変換
         */
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        /**
         * RGBをHSLに変換
         */
        function rgbToHsl(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max == min) {
                h = s = 0; // achromatic
            } else {
                let d = max - min;
                s = l > 0.5? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h, s, l];
        }
    </script>
</body>
</html>
